// -------------------------------------------------------------
//  GENERATOR
// -------------------------------------------------------------
generator client {
  provider = "prisma-client-js"
}

// -------------------------------------------------------------
//  DATASOURCE
// -------------------------------------------------------------
datasource db {
  provider = "postgresql"

}

// -------------------------------------------------------------
// ENUMS  
// -------------------------------------------------------------
enum AtsType {
  greenhouse
  lever
  workday
  gupy
  unknown
}

// Fontes do Crawler
enum JobSourceType {
  manual
  linkedin
  gupy
  greenhouse
  lever
  workday
  adzuna       // <--- Novo
  programathor // <--- Novo
  remotive     // <--- Novo
}

enum SavedJobStatus {
  discovered // = SALVO (Padrão)
  prepared
  applied    // = JÁ ME CANDIDATEI
  sent       // = Email enviado pelo sistema
  screening
  interview
  offer      // = Proposta recebida
  rejected   // = Rejeitado
  closed
}

enum EmailSendStatus {
  queued
  sent
  failed
}

enum EmailProviderType {
  smtp
  gmail_oauth
  microsoft_oauth
}

// -------------------------------------------------------------
// MODELS
// -------------------------------------------------------------

// =======================
// USER
// =======================
model User {
  id            String   @id @default(cuid())
  password      String
  email         String   @unique
  fullName      String?
  phone         String?
  linkedinUrl   String?
  githubUrl     String?

  // --- NOVOS CAMPOS DE PERFIL (ADICIONADOS PARA A PÁGINA SETTINGS) ---
  headline      String?   // Ex: Senior React Developer
  bio           String?   // Resumo profissional
  skills        String[]  // Array: ["React", "Node", "AWS"]
  portfolioUrl  String?
  
  // Preferências de Vaga (JSON flexível)
  jobPreferences Json?    // { "remote": true, "salary": 5000 }

  // Caminho do PDF do Currículo
  resumeUrl     String?
  // -------------------------------------------------------------------

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  savedJobs     SavedJob[]
  emailDrafts   EmailDraft[]
  emailSends    EmailSend[]
  providers     EmailProvider[] 
  template      UserTemplate?

  events Event[] @relation("UserEvents")
}

// =======================
// USER TEMPLATE
// =======================
model UserTemplate {
  id      String @id @default(cuid())
  userId  String @unique

  baseIntro   String?
  baseBullets String?
  closingLine String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// =======================
// COMPANY (CRAWLER)
// =======================
model Company {
  id       String  @id @default(cuid())
  name     String  @unique
  website  String?

  // --- CAMPOS PARA O CRAWLER ---
  atsProvider   AtsType?  // Ex: greenhouse, lever
  careerPageUrl String?   // Slug ou URL
  lastCrawledAt DateTime? // Data da última varredura

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobs Job[]
}

// =======================
// JOB
// =======================
model Job {
  id             String        @id @default(cuid())
   
  // Identificação da Fonte (Importante para o Crawler)
  sourceType     JobSourceType @default(manual)
  sourceKey      String?       // ID único na origem (ex: ID do Adzuna)
  atsType        AtsType       @default(unknown)

  title          String
  location       String?
  remote         Boolean  @default(false)
  description    String
  applyUrl       String
  postedAt       DateTime?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  requirements JobRequirement?
  savedJobs     SavedJob[]
  emailDrafts   EmailDraft[]

  events Event[] @relation("JobEvents")

  // Evita duplicatas da mesma fonte (Crawler)
  @@unique([sourceType, sourceKey])
  @@index([sourceType, sourceKey])
}

// =======================
// JOB REQUIREMENTS
// =======================
model JobRequirement {
  id       String @id @default(cuid())
  jobId    String @unique

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  rawText   String?
  skills    String[] @default([])
  seniority String?
  keywords  String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =======================
// SAVED JOB (PIPELINE)
// =======================
model SavedJob {
  id          String          @id @default(cuid())
  userId      String
  jobId       String
    
  status      SavedJobStatus  @default(discovered)
    
  appliedAt   DateTime? 
    
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  events Event[] @relation("SavedJobEvents")

  @@unique([userId, jobId])
  @@index([status])
  @@index([userId])
  @@index([jobId])
}

// =======================
// EMAIL DRAFT
// =======================
model EmailDraft {
  id      String  @id @default(cuid())
  userId  String
  jobId   String?

  subject     String
  bodyText    String
  toEmail     String?
  attachments String[] @default([])
  checklist   String[] @default([])

  editorOpenedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job? @relation(fields: [jobId], references: [id], onDelete: SetNull)

  sends EmailSend[]

  events Event[] @relation("DraftEvents")

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
}

// =======================
// EMAIL SEND
// =======================
model EmailSend {
  id      String @id @default(cuid())
  userId  String
  draftId String

  providerId String?
  status     EmailSendStatus @default(queued)
  error      String?

  toEmail     String?
  toDomain    String?
  submittedAt DateTime  @default(now())
  sentAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  draft         EmailDraft            @relation(fields: [draftId], references: [id], onDelete: Cascade)
  provider      EmailProvider?        @relation(fields: [providerId], references: [id], onDelete: SetNull)

  events Event[] @relation("SendEvents")

  @@index([status])
  @@index([toDomain, submittedAt])
  @@index([userId])
  @@index([draftId])
}

// =======================
// EMAIL PROVIDER
// =======================
model EmailProvider {
  id              String              @id @default(cuid())
  userId          String
  type            EmailProviderType   @default(smtp)
  isActive        Boolean             @default(true)

  smtpHost        String?
  smtpPort        Int?
  smtpSecure      Boolean?
  smtpUser        String?
  smtpPassEnc     String?

  fromEmail       String?
  fromName        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  sends  EmailSend[]
  events Event[]       @relation("ProviderEvents")

  @@index([userId, type])
}

// =======================
// EVENT (AUDITORIA)
// =======================
model Event {
  id        String   @id @default(cuid())
  type      String
  createdAt DateTime @default(now())

  userId        String?
  jobId         String?
  draftId       String?
  providerId    String?
  sendId        String?
  savedJobId    String?

  metadata Json?

  user       User?                  @relation("UserEvents", fields: [userId], references: [id], onDelete: Cascade)
  job        Job?                   @relation("JobEvents", fields: [jobId], references: [id])
  draft      EmailDraft?            @relation("DraftEvents", fields: [draftId], references: [id])
  provider   EmailProvider?         @relation("ProviderEvents", fields: [providerId], references: [id])
  send       EmailSend?             @relation("SendEvents", fields: [sendId], references: [id])
  savedJob   SavedJob?              @relation("SavedJobEvents", fields: [savedJobId], references: [id])

  @@index([type])
  @@index([createdAt])
  @@index([userId])
  @@index([jobId])
  @@index([draftId])
  @@index([providerId])
  @@index([sendId])
  @@index([savedJobId])
}